<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Dashboard - Strategic Financial Tracking</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #111827;
            --gray: #9ca3af;
            --light: #f3f4f6;
            --white: #ffffff;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-start: #0f172a;
            --bg-end: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.5);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            color: var(--white);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: -1px;
            margin-bottom: 10px;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--gray);
            font-size: 1rem;
        }

        #loading, #error {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            border-radius: 16px;
            margin: 40px auto;
            max-width: 800px;
        }

        #loading { color: var(--gray); }
        #error { color: var(--danger); background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease backwards;
            position: relative;
            /* overflow: hidden; */ /* Removed to prevent tooltip clipping */
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--secondary);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--gradient);
            opacity: 0.7;
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .metric-icon {
            font-size: 0.9rem;
            color: var(--gray);
            width: 16px;
            text-align: center;
        }

        .metric-label-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metric-label {
            color: var(--gray);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0; /* Adjusted */
        }

        .info-tooltip-container {
            position: relative;
            display: inline-block;
        }

        .info-icon {
            color: var(--gray);
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        
        .info-icon:hover {
            color: var(--white);
        }

        .tooltip-text {
            visibility: hidden;
            width: 240px; /* Increased width for better text flow */
            background-color: var(--dark);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 150%;
            left: 50%;
            margin-left: -120px; /* Adjusted for new width */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            text-transform: none;
            line-height: 1.4;
            border: 1px solid var(--border-color);
        }

        .info-tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--white);
        }

        .metric-change {
            font-size: 0.875rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .positive { color: var(--accent); }
        .warning { color: var(--warning); }
        .danger { color: var(--danger); }
        .neutral { color: var(--gray); }

        .section {
            margin-bottom: 40px;
            animation: fadeIn 1s ease backwards;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-title { font-size: 1.5rem; font-weight: 400; }
        
        .chart-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .sunburst-chart {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .allocation-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 16px;
        }

        .allocation-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .allocation-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .allocation-value { font-size: 1.5rem; font-weight: 600; margin-bottom: 4px; }
        .allocation-amount { color: var(--gray); font-size: 0.875rem; }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient);
            border-radius: 8px;
            transition: width 1s ease;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--accent); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        
        .hidden { display: none; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>
    <div class="dashboard">
        <header>
            <h1>Strategic Wealth Dashboard</h1>
            <p class="subtitle">Comprehensive Financial Independence Tracking System</p>
        </header>

        <div id="loading">Loading dashboard data from spreadsheet...</div>
        <div id="error" class="hidden"></div>
        
        <div id="dashboard-content" class="hidden">
            <!-- Key Metrics Overview -->
            <div id="key-metrics" class="metrics-grid">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Portfolio Allocation -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Strategic Asset Allocation</h2>
                    <span id="allocation-status-badge" class="badge"></span>
                </div>
                <div class="chart-container">
                    <div id="sunburst-chart" class="sunburst-chart">
                        <!-- SVG chart will be injected here by JavaScript -->
                    </div>
                </div>
                 <div id="allocation-grid" class="allocation-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Risk Indicators -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Risk & Capital Efficiency</h2>
                </div>
                <div id="risk-metrics" class="metrics-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Financial Independence Journey -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Financial Independence Journey</h2>
                </div>
                <div id="fi-metrics" class="metrics-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION --- //
        const DATA_CONFIG = {
            totalNetWorth: 'Total net worth with Primary Residence',
            investedNetWorth: 'Invested Net Worth',
            cash: 'Cash',
            financialMarkets: 'Financial Markets',
            realEstate: 'Real Estate',
            alternatives: 'Alternatives',
            illiquidAssets: 'Illiquid Assets',
            largestStockPosition: 'Concentrated Google Position',
            liquidityRunwayMonths: 'Liquidity / Runway (months)',
            // User needs to add these rows to their sheet for full functionality
            annualPassiveIncome: 'Annual Passive Income',
            annualExpenses: 'Annual Expenses',
            annualGrossIncome: 'Annual Gross Income',
            age: 'Age',
        };

        const BENCHMARKS = {
            investedNWRatio: { low: 70, high: 85 },
            singleStockConcentration: { warn: 5, high: 10 },
            illiquidAssets: { low: 15, high: 30 },
            liquidityRunway: { low: 12, high: 24 },
            portfolioYield: { low: 3, high: 4 },
            savingsRate: { strong: 30, excellent: 50 },
            fiSWR: 0.03,
        };
        
        // --- INITIALIZATION --- //
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                console.warn("Not in Google Apps Script environment. Using mock data.");
                const mockData = [
                    ['Total net worth with Primary Residence', '$ 425,000'],
                    ['Invested Net Worth', '$ 350,000'],
                    ['Cash', '$ 25,000'],
                    ['Financial Markets', '$ 275,000'],
                    ['Real Estate', '$ 35,000'],
                    ['Alternatives', '$ 15,000'],
                    ['Illiquid Assets', '$ 75,000'],
                    ['Concentrated Google Position', '$ 45,000'],
                    ['Liquidity / Runway (months)', '8'],
                    ['Annual Passive Income', '$ 12,250'],
                    ['Annual Expenses', '$ 48,000'],
                    ['Annual Gross Income', '$ 95,000'],
                    ['Age', '35'],
                ];
                processSheetData(mockData);
            } else {
                google.script.run
                    .withSuccessHandler(processSheetData)
                    .withFailureHandler(showError)
                    .getSheetData();
            }
        });

        // --- DATA PROCESSING --- //
        function parseFinancialValue(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const cleaned = value.replace(/[$,\s]/g, '');
                const number = parseFloat(cleaned);
                return isNaN(number) ? 0 : number;
            }
            return 0;
        }

        function processSheetData(data) {
            try {
                if (!data || data.length === 0) throw new Error('No data received from spreadsheet.');
                
                const dataMap = new Map(data.filter(row => row && row[0]).map(row => {
                    const key = String(row[0]).replace(/[\s\u00A0]+/g, ' ').trim();
                    const value = row[1];
                    return [key, value];
                }));


                if (dataMap.size === 0) throw new Error('Could not parse any valid key-value pairs from the spreadsheet.');

                const rawData = {};
                for (const key in DATA_CONFIG) {
                    rawData[key] = parseFinancialValue(dataMap.get(DATA_CONFIG[key]));
                }
                
                const dashboardData = calculateAllMetrics(rawData);
                renderDashboard(dashboardData);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

            } catch (error) {
                showError(error);
            }
        }

        function calculateAllMetrics(data) {
            const metrics = { ...data };
            
            metrics.investedNWRatio = data.totalNetWorth > 0 ? (data.investedNetWorth / data.totalNetWorth * 100) : 0;
            
            metrics.illiquidAssetsPercent = data.totalNetWorth > 0 ? (data.illiquidAssets / data.totalNetWorth * 100) : 0;
            
            // --- FIX ---
            // For allocation percentages, the denominator MUST be the sum of the parts to ensure it totals 100%.
            // This avoids discrepancies if the provided "Invested Net Worth" is different from the sum of its components.
            const totalInvestedForAllocation = data.cash + data.financialMarkets + data.realEstate + data.alternatives;
            metrics.totalInvestedForAllocation = totalInvestedForAllocation;

            if (totalInvestedForAllocation > 0) {
                metrics.cashPercent = (data.cash / totalInvestedForAllocation * 100);
                metrics.marketsPercent = (data.financialMarkets / totalInvestedForAllocation * 100);
                metrics.realEstatePercent = (data.realEstate / totalInvestedForAllocation * 100);
                metrics.alternativesPercent = (data.alternatives / totalInvestedForAllocation * 100);
            } else {
                Object.assign(metrics, { cashPercent: 0, marketsPercent: 0, realEstatePercent: 0, alternativesPercent: 0 });
            }
            // --- END FIX ---

            if (data.investedNetWorth > 0) {
                metrics.singleStockPercent = (data.largestStockPosition / data.investedNetWorth * 100);
                metrics.portfolioYield = (data.annualPassiveIncome / data.investedNetWorth * 100);
            } else {
                 Object.assign(metrics, { singleStockPercent: 0, portfolioYield: 0 });
            }

            metrics.passiveIncomeCoverage = data.annualExpenses > 0 ? (data.annualPassiveIncome / data.annualExpenses * 100) : 0;
            
            metrics.fiNumber = data.annualExpenses / BENCHMARKS.fiSWR;
            metrics.fiProgress = metrics.fiNumber > 0 ? (data.investedNetWorth / metrics.fiNumber * 100) : 0;
            metrics.overallSavingsRate = data.annualGrossIncome > 0 ? ((data.annualGrossIncome - data.annualExpenses) / data.annualGrossIncome * 100) : 0;
            
            return metrics;
        }

        // --- RENDERING --- //
        function renderDashboard(data) {
            renderKeyMetrics(data);
            renderAllocation(data);
            renderRiskMetrics(data);
            renderFIMetrics(data);
        }

        function formatCurrency(value, short = false) {
             if (short && value >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M';
            }
            if (short && value >= 1000) {
                return '$' + (value / 1000).toFixed(1) + 'K';
            }
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        }

        function renderKeyMetrics(data) {
            document.getElementById('key-metrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-header">
                        <i class="fas fa-star metric-icon"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">Total Net Worth</div>
                            <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">The comprehensive, traditional measure of a household's balance sheet, calculated by subtracting total liabilities from the total market value of all assets.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${formatCurrency(data.totalNetWorth)}</div>
                    <div class="metric-change neutral">Foundational balance sheet metric</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <i class="fas fa-leaf metric-icon"></i>
                        <div class="metric-label-container">
                             <div class="metric-label">Invested Net Worth</div>
                             <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">Isolates the capital that is actively deployed to generate a return. It excludes non-productive 'lifestyle' assets like a primary residence. This is the engine of future growth.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${formatCurrency(data.investedNetWorth)}</div>
                    <div class="metric-change positive">The engine of future growth</div>
                </div>
                <div class="metric-card">
                     <div class="metric-header">
                        <i class="fas fa-flag-checkered metric-icon"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">FI Progress</div>
                            <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">Your current Invested Net Worth as a percentage of your total Financial Independence (FI) Number. A direct measure of your progress toward making work optional.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${data.fiProgress.toFixed(1)}%</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: ${data.fiProgress}%"></div></div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <i class="fas fa-stream metric-icon"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">Passive Income Coverage</div>
                            <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">The percentage of your annual living expenses covered by passive income from your investments. Reaching 100% is the definition of Financial Independence.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${data.passiveIncomeCoverage.toFixed(1)}%</div>
                    <div class="metric-change neutral">${formatCurrency(data.annualPassiveIncome)} / ${formatCurrency(data.annualExpenses)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <i class="fas fa-hourglass-half metric-icon"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">Liquidity Runway</div>
                             <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">Measures how many months you could maintain your current lifestyle using only your liquid assets, without any additional income. A key measure of financial resilience.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${data.liquidityRunwayMonths.toFixed(0)} months</div>
                    <div class="metric-change ${data.liquidityRunwayMonths >= BENCHMARKS.liquidityRunway.low && data.liquidityRunwayMonths <= BENCHMARKS.liquidityRunway.high ? 'positive' : 'warning'}">Target: 12-24 months</div>
                </div>
                <div class="metric-card">
                     <div class="metric-header">
                        <i class="fas fa-chart-bar metric-icon"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">Overall Savings Rate</div>
                            <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">The percentage of your gross income you are saving and investing across all accounts. This is the most powerful lever for accelerating your journey to FI.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${data.overallSavingsRate.toFixed(1)}%</div>
                    <div class="metric-change ${data.overallSavingsRate >= BENCHMARKS.savingsRate.excellent ? 'positive' : 'neutral'}">${data.overallSavingsRate >= BENCHMARKS.savingsRate.excellent ? 'Accelerator' : 'Strong'}</div>
                </div>
            `;
        }
        
        // --- SVG Sunburst Chart Generation ---
        function createSunburstSVG(data) {
            const assets = [
                { label: 'Cash', value: data.cash, color: 'rgba(59, 130, 246, 0.8)' },
                { label: 'Financial Markets', value: data.financialMarkets, color: 'rgba(139, 92, 246, 0.8)' },
                { label: 'Real Estate', value: data.realEstate, color: 'rgba(16, 185, 129, 0.8)' },
                { label: 'Alternatives', value: data.alternatives, color: 'rgba(245, 158, 11, 0.8)' }
            ];
            
            const allocations = assets.map(asset => ({
                ...asset,
                percent: data.totalInvestedForAllocation > 0 ? (asset.value / data.totalInvestedForAllocation) * 100 : 0
            }));

            const cx = 200, cy = 200, innerRadius = 60, outerRadius = 140;
            let cumulativePercent = 0;

            const polarToCartesian = (centerX, centerY, radius, angleInDegrees) => {
                const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
                return {
                    x: centerX + (radius * Math.cos(angleInRadians)),
                    y: centerY + (radius * Math.sin(angleInRadians))
                };
            };
            
            const paths = allocations.map(item => {
                const startAngle = cumulativePercent / 100 * 360;
                cumulativePercent += item.percent;
                const endAngle = cumulativePercent / 100 * 360;
                
                if (item.percent === 0) return '';

                const startOuter = polarToCartesian(cx, cy, outerRadius, startAngle);
                const endOuter = polarToCartesian(cx, cy, outerRadius, endAngle);
                const startInner = polarToCartesian(cx, cy, innerRadius, startAngle);
                const endInner = polarToCartesian(cx, cy, innerRadius, endAngle);
                
                const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

                const d = [
                    "M", startOuter.x, startOuter.y,
                    "A", outerRadius, outerRadius, 0, largeArcFlag, 1, endOuter.x, endOuter.y,
                    "L", endInner.x, endInner.y,
                    "A", innerRadius, innerRadius, 0, largeArcFlag, 0, startInner.x, startInner.y,
                    "Z"
                ].join(" ");
                
                return `<path d="${d}" fill="${item.color}" stroke="var(--card-bg)" stroke-width="2"></path>`;
            }).join('');
            
            cumulativePercent = 0; // Reset for labels
            const labels = allocations.map(item => {
                 if (item.percent < 4) return ''; // Hide labels for small segments
                 const midAngle = (cumulativePercent + item.percent / 2) / 100 * 360;
                 cumulativePercent += item.percent;
                 const pos = polarToCartesian(cx, cy, (innerRadius + outerRadius) / 2, midAngle);
                 return `<text x="${pos.x}" y="${pos.y}" text-anchor="middle" dominant-baseline="central" fill="white" font-size="14">${item.percent.toFixed(0)}%</text>`;
            }).join('');


            return `
                <svg viewBox="0 0 400 400">
                    ${paths}
                    <circle cx="200" cy="200" r="${innerRadius}" fill="rgba(255,255,255,0.05)"/>
                    <text x="200" y="195" text-anchor="middle" fill="white" font-size="24" font-weight="600">${formatCurrency(data.totalInvestedForAllocation, true)}</text>
                    <text x="200" y="215" text-anchor="middle" fill="#9ca3af" font-size="12">Invested Portfolio</text>
                    ${labels}
                </svg>
            `;
        }


        function renderAllocation(data) {
            // SVG Chart
            const svgChartHTML = createSunburstSVG(data);
            document.getElementById('sunburst-chart').innerHTML = svgChartHTML;

            // Allocation Grid
            const allocations = [
                { label: 'Cash', percent: data.cashPercent, amount: data.cash, color: '#3b82f6' },
                { label: 'Financial Markets', percent: data.marketsPercent, amount: data.financialMarkets, color: '#8b5cf6' },
                { label: 'Real Estate', percent: data.realEstatePercent, amount: data.realEstate, color: '#10b981' },
                { label: 'Alternatives', percent: data.alternativesPercent, amount: data.alternatives, color: '#f59e0b' }
            ];

            document.getElementById('allocation-grid').innerHTML = allocations.map(item => `
                <div class="allocation-item">
                    <div class="allocation-label">
                        <span class="allocation-dot" style="background: ${item.color}"></span>
                        <div class="metric-label-container">
                            <span>${item.label}</span>
                             <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">${getTooltipTextForAllocation(item.label)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="allocation-value">${item.percent.toFixed(1)}%</div>
                    <div class="allocation-amount">${formatCurrency(item.amount)}</div>
                </div>`).join('');

            // Status Badge
            const badge = document.getElementById('allocation-status-badge');
            if (data.realEstatePercent > 30) {
                badge.className = 'badge badge-warning'; badge.textContent = 'Real Estate Heavy';
            } else {
                badge.className = 'badge badge-success'; badge.textContent = 'Balanced';
            }
        }
        
        function getTooltipTextForAllocation(label) {
            switch (label) {
                case 'Cash': return "Includes both strategic cash reserves held for investment opportunities and defensive cash held in emergency funds. A key component for liquidity and risk management.";
                case 'Financial Markets': return "Your holdings in publicly traded assets, including stocks, bonds, and ETFs. This is the primary engine for long-term, liquid growth.";
                case 'Real Estate': return "Represents your investment in income-producing properties, excluding your primary residence. Provides diversification, inflation hedging, and potential tax advantages.";
                case 'Alternatives': return "Investments outside of traditional stocks, bonds, and real estate, such as private equity, venture capital, or collectibles. Can offer non-correlated returns.";
                default: return "Asset allocation category.";
            }
        }
        
        function renderRiskMetrics(data) {
             const concentrationClass = data.singleStockPercent >= BENCHMARKS.singleStockConcentration.high ? 'danger' 
                                      : (data.singleStockPercent >= BENCHMARKS.singleStockConcentration.warn ? 'warning' : 'positive');

             document.getElementById('risk-metrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-header">
                         <i class="fas fa-cogs metric-icon"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">Invested Net Worth Ratio</div>
                             <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">Measures the efficiency of your capital deployment (Invested NW / Total NW). A healthy range for a high-net-worth investor is typically 70-85%.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${data.investedNWRatio.toFixed(1)}%</div>
                    <div class="metric-change ${data.investedNWRatio >= BENCHMARKS.investedNWRatio.low ? 'positive' : 'warning'}">Target: ${BENCHMARKS.investedNWRatio.low}-${BENCHMARKS.investedNWRatio.high}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                         <i class="fas fa-exclamation-triangle metric-icon ${concentrationClass}"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">Single Stock Concentration</div>
                             <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">The percentage of your portfolio in a single stock. Positions over 10% represent a significant, uncompensated risk that should be strategically managed.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${data.singleStockPercent.toFixed(1)}%</div>
                    <div class="metric-change ${concentrationClass}">Target: < ${BENCHMARKS.singleStockConcentration.high}%</div>
                </div>
                <div class="metric-card">
                     <div class="metric-header">
                         <i class="fas fa-gem metric-icon"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">Illiquid Assets %</div>
                             <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">The percentage of your entire balance sheet (Total Net Worth) tied up in assets that are not easily converted to cash. This provides a high-level view of your overall financial flexibility.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${data.illiquidAssetsPercent.toFixed(1)}%</div>
                    <div class="metric-change ${data.illiquidAssetsPercent >= BENCHMARKS.illiquidAssets.low && data.illiquidAssetsPercent <= BENCHMARKS.illiquidAssets.high ? 'positive' : 'warning'}">Target: 15-30%</div>
                </div>
            `;
        }

        function renderFIMetrics(data) {
            document.getElementById('fi-metrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-header">
                        <i class="fas fa-flag-checkered metric-icon"></i>
                        <div class="metric-label-container">
                             <div class="metric-label">FI Number (Conservative)</div>
                             <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">The total capital required to achieve FI, calculated using a conservative 3% Sustainable Withdrawal Rate (SWR). This provides a greater margin of safety for long-term plans.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${formatCurrency(data.fiNumber)}</div>
                    <div class="metric-change neutral">Based on 3% SWR</div>
                </div>
                 <div class="metric-card">
                    <div class="metric-header">
                        <i class="fas fa-percent metric-icon"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">Portfolio Yield</div>
                             <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">The annual passive income generated by your portfolio as a percentage of your Invested Net Worth. A sustainable yield is typically in the 3-4% range.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">${data.portfolioYield.toFixed(1)}%</div>
                    <div class="metric-change ${data.portfolioYield >= BENCHMARKS.portfolioYield.low ? 'positive' : 'neutral'}">Target: ${BENCHMARKS.portfolioYield.low}-${BENCHMARKS.portfolioYield.high}%</div>
                </div>
                <div class="metric-card">
                     <div class="metric-header">
                        <i class="fas fa-calendar-alt metric-icon"></i>
                        <div class="metric-label-container">
                            <div class="metric-label">Years to FI (Projected)</div>
                             <div class="info-tooltip-container">
                                <i class="fas fa-info-circle info-icon"></i>
                                <span class="tooltip-text">A simplified projection based on your current savings rate and an assumed 5% real rate of return.</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-value">-- years</div>
                    <div class="metric-change neutral">Calculation pending</div>
                </div>
            `;
        }

        function showError(error) {
            document.getElementById('loading').classList.add('hidden');
            const errorDiv = document.getElementById('error');
            errorDiv.classList.remove('hidden');
            errorDiv.innerHTML = `<strong>Error:</strong> ${error.message || 'An unknown error occurred.'} <br>Please check your spreadsheet data, permissions, and ensure all required metrics are present in column A.`;
            console.error(error);
        }
    </script>
</body>
</html>
